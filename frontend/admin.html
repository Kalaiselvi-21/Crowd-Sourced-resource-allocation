<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Allocation</title>
  </head>
  <body>
    <h2>Admin Resource Allocation</h2>

    <div id="adminRequests"></div>

    <br />
    <button onclick="goBack()">Back to Dashboard</button>

    <script src="js/api.js"></script>
    <script>
      // Protect page
      if (!localStorage.getItem("token")) {
        window.location.href = "login.html";
      }

      async function loadAdminRequests() {
        try {
          const data = await apiRequest("/requests/ranking");

          const container = document.getElementById("adminRequests");
          container.innerHTML = "";

          if (!data || data.length === 0) {
            container.innerHTML = "<p>No requests available</p>";
            return;
          }

          data.forEach((req) => {
            const div = document.createElement("div");
            div.style.border = "1px solid #ccc";
            div.style.padding = "10px";
            div.style.marginBottom = "10px";

            let actionHTML = "";
            const status = (req.status || "Pending").trim().toLowerCase();
            if (!req.status || req.status === "Pending") {
              actionHTML = `<button onclick="allocate('${req._id}')">Allocate</button>`;
            } else {
              actionHTML = `<strong>Status: ${req.status}</strong>`;
            }

            div.innerHTML = `
        <strong>${req.resourceName}</strong><br>
        Quantity: ${req.quantity}<br>
        Urgency: ${req.urgency}<br>
        Votes: ${req.votes}<br>
        Final Score: ${req.finalScore}<br>
        ${actionHTML}
      `;

            container.appendChild(div);
          });
        } catch (error) {
          console.error(error);
          alert("Admin access only");
        }
      }

      async function allocate(id) {
        try {
          const res = await apiRequest(`/admin/allocate/${id}`, "PUT");
          alert(res.message);
          loadAdminRequests();
        } catch (error) {
          console.error(error);
          alert("Allocation failed");
        }
      }

      function goBack() {
        window.location.href = "dashboard.html";
      }

      loadAdminRequests();
    </script>
  </body>
</html>
