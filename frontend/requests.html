<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>View & Vote Requests</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <h2>All Resource Requests</h2>

    <div id="requestList"></div>

    <br />
    <button onclick="goBack()">Back to Dashboard</button>

    <script src="js/api.js"></script>
    <script>
      // Protect page
      if (!localStorage.getItem("token")) {
        window.location.href = "login.html";
      }

      // Load all requests
      async function loadRequests() {
        try {
          const requests = await apiRequest("/requests");
          const container = document.getElementById("requestList");
          container.innerHTML = "";

          if (!requests || requests.length === 0) {
            container.innerHTML = "<p>No requests found</p>";
            return;
          }

          requests.forEach((req) => {
            const div = document.createElement("div");
            div.style.border = "1px solid #ccc";
            div.style.padding = "10px";
            div.style.marginBottom = "10px";

            const status = (req.status || "Pending").toLowerCase();
            let voteBtn = "";

            if (status === "pending") {
              voteBtn = `<button onclick="voteRequest('${req._id}')">üëç Vote</button>`;
            } else {
              voteBtn = `<strong>Status: ${req.status}</strong>`;
            }

            div.innerHTML = `
              <strong>Resource:</strong> ${req.resourceName}<br>
              <strong>Quantity:</strong> ${req.quantity}<br>
              <strong>Urgency:</strong> ${req.urgency}<br>
              <strong>Justification:</strong> ${req.justification}<br>
              <strong>Votes:</strong> ${req.votes || 0}<br><br>
              ${voteBtn}
            `;

            container.appendChild(div);
          });
        } catch (error) {
          console.error(error);
          alert("Failed to load requests");
        }
      }

      // Vote a request
      async function voteRequest(id) {
        try {
          await apiRequest(`/requests/${id}/vote`, "PUT", { vote: 1 });
          alert("Vote submitted");
          loadRequests();
        } catch (error) {
          console.error(error);
          alert("Voting failed");
        }
      }

      function goBack() {
        window.location.href = "dashboard.html";
      }

      loadRequests();
    </script>
  </body>
</html>
